<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Apple Price Compare KS</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div class="background"></div>
  <div class="noise"></div>
  <header class="shell">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="title">KS Price Compare</div>
        <div class="subtitle">Apple iPhone in Kosove</div>
      </div>
    </div>
    <div class="pills">
      <span class="pill accent">Live from Atlas</span>
      <span class="pill ghost">FastAPI + BS4</span>
    </div>
  </header>

  <main class="shell main-grid">
    <section class="hero glass">
      <div>
        <p class="eyebrow">Price Intelligence</p>
        <h1>Gjej oferten me te lire per iPhone.</h1>
        <p class="lede">Krahaso cmimet nga Neptun, GjirafaMall, Aztech dhe ShopAz ne kohe reale.</p>
        <div class="controls">
          <input id="searchInput" type="search" placeholder='Kerko p.sh. "iphone 15 pro max"' />
          <button id="searchBtn">Kerko</button>
          <button id="refreshBtn" class="ghost">Rifresko</button>
          <span id="status" class="status"></span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Produkte</div>
        <div class="stat-value" id="productCount">-</div>
        <div class="stat-foot">Kliko produktin per te hapur oferten me te lire</div>
      </div>
    </section>

    <section class="list glass">
      <div class="section-head">
        <h2>iPhone nga providera te ndryshem</h2>
      </div>
      <div id="products" class="product-grid empty">Duke ngarkuar...</div>
    </section>

    <section class="panel glass">
      <div class="section-head">
        <div>
          <p class="eyebrow">Oferta</p>
          <h3 id="selectedProduct">Zgjidh nje produkt</h3>
        </div>
        <div id="cheapest" class="pill ghost"></div>
      </div>
      <div id="prices" class="prices empty">Asnje produkt i zgjedhur.</div>
    </section>
  </main>

  <footer class="shell footer">
    <div>Powered by FastAPI + MongoDB Atlas + BeautifulSoup</div>
    <div>UI insp. Vercel clean + Made for KS market</div>
  </footer>

  <script>
    const productsEl = document.getElementById("products");
    const pricesEl = document.getElementById("prices");
    const statusEl = document.getElementById("status");
    const productCountEl = document.getElementById("productCount");
    const selectedProductEl = document.getElementById("selectedProduct");
    const cheapestEl = document.getElementById("cheapest");
    const searchInput = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const refreshBtn = document.getElementById("refreshBtn");

    const apiBase = "";
    const storeNames = {
      gjirafamall: "Gjirafa",
      neptun: "Neptun",
      aztech: "Aztech",
      shopaz: "ShopAz",
      tecstore: "TecStore",
    };

    function storeLabelFromCode(code) {
      return storeNames[code] || code || "Unknown";
    }

    function setStatus(text, isError = false) {
      statusEl.textContent = text || "";
      statusEl.className = isError ? "status error" : "status";
    }

    function renderProducts(items) {
      productsEl.classList.remove("empty");
      if (!items.length) {
        productsEl.innerHTML = "<div class='empty-note'>Asnje produkt.</div>";
        productCountEl.textContent = "0";
        return;
      }
      productCountEl.textContent = items.length;
      const storeLabel = (stores) => {
        const list = Array.isArray(stores) ? stores : [];
        const hasGjirafa = list.includes("gjirafamall");
        const hasNeptun = list.includes("neptun");
        if (hasGjirafa && hasNeptun) {
          return { label: "Gjirafa + Neptun", cls: "store-badge both" };
        }
        if (hasGjirafa) {
          return { label: "Gjirafa", cls: "store-badge gjirafa" };
        }
        if (hasNeptun) {
          return { label: "Neptun", cls: "store-badge neptun" };
        }
        if (list.length) {
          return { label: "Other shops", cls: "store-badge other" };
        }
        return { label: "No offers", cls: "store-badge empty" };
      };
      productsEl.innerHTML = items
        .map((p) => {
          const badge = storeLabel(p.stores);
          const prices = Array.isArray(p.latest_prices) ? p.latest_prices : [];
          const priceHtml = prices.length
            ? prices
                .map(
                  (entry) =>
                    `<span class="price-chip ${entry.store}">${storeLabelFromCode(entry.store)}: ${formatPrice(
                      entry
                    )}</span>`
                )
                .join("")
            : "<span class='price-chip empty'>No prices</span>";
          return `
          <article class="product-card" data-sku="${p.sku}" data-name="${p.name}">
            <div class="card-meta">
              <div class="pill ghost small">SKU</div>
              <div class="${badge.cls}">${badge.label}</div>
            </div>
            <h3>${p.name}</h3>
            <p class="muted">${p.sku}</p>
            <div class="price-chips">${priceHtml}</div>
            <button class="ghost full">Shiko ofertat</button>
          </article>
        `;
        })
        .join("");
      productsEl.querySelectorAll(".product-card").forEach((card) => {
        card.addEventListener("click", () => {
          const sku = card.dataset.sku;
          const name = card.dataset.name;
          openCheapestOffer(sku, name);
        });
        const button = card.querySelector("button");
        if (button) {
          button.addEventListener("click", (event) => {
            event.stopPropagation();
            const sku = card.dataset.sku;
            const name = card.dataset.name;
            loadPrices(sku, name);
          });
        }
      });
    }

    function formatPrice(entry) {
      const symbol = (entry.currency || "EUR").toUpperCase() === "EUR" ? "â‚¬" : entry.currency;
      const formatter = new Intl.NumberFormat("en-US", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2,
      });
      return `${formatter.format(entry.price)} ${symbol}`;
    }

    function renderPrices(name, entries) {
      selectedProductEl.textContent = name;
      pricesEl.classList.remove("empty");
      if (!entries.length) {
        pricesEl.innerHTML = "<div class='empty-note'>Asnje oferte e gjetur.</div>";
        cheapestEl.textContent = "";
        return;
      }
      const cheapest = entries.reduce((min, e) => (e.price < min.price ? e : min), entries[0]);
      cheapestEl.textContent = `Nga ${cheapest.store}: ${formatPrice(cheapest)}`;
      pricesEl.innerHTML = `
        <div class="price-table">
          <div class="price-row head">
            <span>Dyqani</span>
            <span>Cmimi</span>
            <span>Link</span>
            <span>Koha</span>
          </div>
          ${entries
            .map(
              (e) => `
              <div class="price-row">
                <span>${e.store}</span>
                <span>${formatPrice(e)}</span>
                <span><a href="${e.product_url}" target="_blank" rel="noopener noreferrer">Hap</a></span>
                <span>${new Date(e.timestamp).toLocaleString()}</span>
              </div>
            `
            )
            .join("")}
        </div>
      `;
    }

    async function loadProducts(query = "") {
      setStatus("Duke ngarkuar...");
      try {
        const url = `${apiBase}/products${query ? `?q=${encodeURIComponent(query)}` : ""}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        renderProducts(data);
        setStatus(`Gjetem ${data.length} produkte`);
      } catch (err) {
        console.error(err);
        setStatus("Gabim ne listen e produkteve", true);
        productsEl.innerHTML = "<div class='empty-note'>Nuk u ngarkuan produktet.</div>";
      }
    }

    async function loadPrices(sku, name) {
      setStatus(`Duke lexuar ofertat per ${name}...`);
      pricesEl.innerHTML = "<div class='empty-note'>Loading...</div>";
      try {
        const res = await fetch(`${apiBase}/products/${encodeURIComponent(sku)}/prices`);
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        renderPrices(name, data);
        setStatus(`Gjetem ${data.length} oferta`);
      } catch (err) {
        console.error(err);
        setStatus("Gabim ne ofertat e produktit", true);
        pricesEl.innerHTML = "<div class='empty-note'>Nuk u ngarkuan ofertat.</div>";
      }
    }

    async function openCheapestOffer(sku, name) {
      setStatus(`Duke hapur oferten me te lire per ${name}...`);
      try {
        const res = await fetch(`${apiBase}/products/${encodeURIComponent(sku)}/prices`);
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        if (!data.length || !data[0].product_url) {
          setStatus("Nuk u gjet link per produktin", true);
          return;
        }
        window.open(data[0].product_url, "_blank", "noopener");
        setStatus(`Hapur oferta nga ${data[0].store || "dyqan"}`);
      } catch (err) {
        console.error(err);
        setStatus("Gabim ne hapjen e linkut", true);
      }
    }

    searchBtn.addEventListener("click", () => {
      loadProducts(searchInput.value.trim());
    });

    refreshBtn.addEventListener("click", () => {
      searchInput.value = "";
      loadProducts("");
    });

    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        loadProducts(searchInput.value.trim());
      }
    });

    // Initial load filtered to iPhone
    loadProducts("iphone");
  </script>
</body>
</html>
